<html>
    <head>
        <title>Missions</title>
        <script src="script/socket.io.js"></script>
        <script src="script/AgoraSig.js"></script>
    </head>

    <style id="myStyle">
        html, body {
            margin: 0;
            height: 100%;
        }

        .sensor {
            position : absolute;
        }
    </style>

    <body>
        <img src="images/mission.png" height="100%"></image>
    </body>

    <script>
        const style = document.getElementsByTagName("style")[0]
        const image = document.getElementsByTagName("img")[0];
        const ratio = image.naturalWidth/image.naturalHeight;
        var scale = image.clientWidth/image.naturalWidth;
        window.addEventListener("resize", event => {
            image.width = image.height * ratio;
            scale = image.clientWidth/image.naturalWidth;

            sensors.forEach(sensor => resizeSensor(sensor));
        });
    </script>

    <script>
        const sensors = [];
        const sensorStyle = style.sheet.cssRules[1]
        const addSensor = (x, y) => {
            const sensor = document.createElement("div");
            sensor.className = "sensor";
            sensor.dataset.index = sensors.length;
            sensor.dataset.x = x;
            sensor.dataset.y = y;
            document.body.appendChild(sensor);
            sensors.push(sensor);
            resizeSensor(sensor);
        }
        const resizeSensor = sensor => {
            const x = Number(sensor.dataset.x);
            const y = Number(sensor.dataset.y);

            sensor.style.left = x*image.clientWidth;
            sensor.style.top = y*image.clientHeight;

            sensor.style.width = sensor.style.height = scale*65;
        }

        addSensor(0.37, 0.69);
        addSensor(0.37, 0.851);
        addSensor(0.365, 0.782);
        addSensor(0.455, 0.151);
        addSensor(0.377, 0.263);
        addSensor(0.502, 0.23);
        addSensor(0.365, 0.374);
        addSensor(0.42, 0.453);
        addSensor(0.467, 0.342);
        addSensor(0.584, 0.305);
        addSensor(0.62, 0.211);
        addSensor(0.55, 0.421);
        addSensor(0.599, 0.105);
        addSensor(0.48, 0.852);
        addSensor(0.481, 0.783);
        addSensor(0.484, 0.69);

    </script>

    <script>
        // Aora-io streaming    
        const config = {
            appID : "1f512872e3ba4a78831aea62af4dcf36",
            token : "_no_need_token",
            certificateID : "96f2268625454c1097c26f0b5fdafa9e",
            channelName : "Missions",
        };
    
        const signal = new Signal(config.appID);
    
        var session, channel;
        var channelJoined = false;
    
        session = signal.login("sender", config.token);
        if(session !== undefined) {
            session.onLoginSuccess = uid => {
                console.log(`Logged in.\nUser id: ${uid}`);
    
                channel = session.channelJoin(config.channelName);
                channel.onChannelJoined = () => {
                    console.log(`Joined channel "${config.channelName}"`);
                    channelJoined = true;
                }
            }
    
            session.onLogout = (errorCode) => {
                console.log(`Logging out of session`)
            }    
        }
        
    </script>

    <script>
        const socket = new io();
        socket.on("message", message => {
            const json = JSON.parse(message);
            json.values.forEach((value, index) => {
                if(index == 3) return;

                sensors[index].style.backgroundColor = `rgba(0, 255, 0, ${value/100})`;
            });

            if(channelJoined)
                channel.messageChannelSend(message);
        });
    </script>
</html>